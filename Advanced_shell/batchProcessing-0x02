#!/bin/bash
# Batch fetch Pokemon data with error handling and retry logic

API_URL="https://pokeapi.co/api/v2/pokemon"
OUTPUT_DIR="pokemon_data"
ERROR_LOG="fetch_errors.txt"
MAX_RETRIES=3
DELAY=2

# Pokemon list
POKEMON_LIST=("bulbasaur" "ivysaur" "venusaur" "charmander" "charmeleon")

# Create output directory
mkdir -p "$OUTPUT_DIR"

# Clear previous error log
> "$ERROR_LOG"

# Function to fetch Pokemon data with retry logic
fetch_pokemon() {
    local pokemon=$1
    local output_file="$OUTPUT_DIR/${pokemon}.json"
    local retry_count=0
    
    echo "Fetching data for $pokemon..."
    
    while [ $retry_count -lt $MAX_RETRIES ]; do
        # Make API request
        http_code=$(curl -s -o "$output_file" -w "%{http_code}" "$API_URL/$pokemon")
        
        if [ "$http_code" = "200" ]; then
            echo "Saved data to $output_file [SUCCESS]"
            return 0
        else
            retry_count=$((retry_count + 1))
            if [ $retry_count -lt $MAX_RETRIES ]; then
                echo "  [WARNING] Request failed (attempt $retry_count/$MAX_RETRIES). Retrying..."
                sleep $DELAY
            fi
        fi
    done
    
    # Log error after max retries
    echo "[ERROR] Failed to fetch data for $pokemon after $MAX_RETRIES attempts" | tee -a "$ERROR_LOG"
    echo "  Pokemon: $pokemon, HTTP Code: $http_code, Timestamp: $(date)" >> "$ERROR_LOG"
    return 1
}

# Fetch data for each Pokemon
for pokemon in "${POKEMON_LIST[@]}"; do
    fetch_pokemon "$pokemon"
    sleep 1  # Rate limiting delay
done

echo ""
echo "Batch processing complete!"
if [ -s "$ERROR_LOG" ]; then
    echo "[WARNING] Some errors occurred. Check $ERROR_LOG for details."
else
    echo "[SUCCESS] All Pokemon data fetched successfully!"
fi
